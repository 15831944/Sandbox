<!DOCTYPE HTML>
<html lang="en">
<head>
<title>Move Line</title>
<meta charset = "UTF-8"/>

<!-- Update the path to paper js -->
<script type="text/javascript" src="raphael.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>

<style type="text/css">
svg {
    border: solid 1px #000;
}
</style>

</head>
<body>
<div id="canvas"></div>
<button type="button" id="clearBtn">Clear</button>
</body>
</html>

<script type="text/javascript"> 
    //<![CDATA[
    var CANVAS_WIDTH = 500;
    var CANVAS_HEIGHT = 500;
    var LINE_WIDTH = 5;
    var CONTROL_POINT_RADIOUS = 10;

    function Line(startX, startY, endX, endY, paper) {
        var start = {
            x: startX,
            y: startY
        };
        var end = {
            x: endX,
            y: endY
        };

        Line.prototype.updateStart = function (x, y) {
            start.x = x;
            start.y = y;
            redraw();
            return this;
        }

        Line.prototype.updateEnd = function (x, y) {
            end.x = x;
            end.y = y;
            redraw();
            return this;
        }

        Line.prototype.enableEdit = function () {
            gizmo.click(function () {
                var startGizmo;
                var endGizmo;

                gizmo.attr("stroke", "blue");
                // Show the control points
                startGizmo = paper.circle(start.x, start.y, CONTROL_POINT_RADIOUS);
                if (!endGizmo)
                    endGizmo = paper.circle(end.x, end.y, CONTROL_POINT_RADIOUS);
                else
                    endGizmo.attr({ cx: end.x, cy: end.y });

                startGizmo.attr({ fill: "yellow" });
                endGizmo.attr({ fill: "yellow" });

                var endEdit = function () {
                    startGizmo.attr({ cx: start.x, cy: start.y });
                    endGizmo.attr({ cx: end.x, cy: end.y });
                    gizmo.attr("stroke", "red");
                    // Clear the control points
                    startGizmo.remove();
                    endGizmo.remove();
                }

                var dragstart = function () {
                }

                var dragend = function () {
                    end.x = endGizmo.attr("cx");
                    end.y = endGizmo.attr("cy");

                    endEdit();
                }

                var endmove = function (dx, dy) {
                    end.x += dx;
                    end.y += dy;
                    redraw();
                    endGizmo.attr({ cx: end.x, cy: end.y });
                    end.x -= dx;
                    end.y -= dy;
                    str = dx + ";" + dy;
                    console.log(dx, dy)
                }

                endGizmo.drag(endmove, dragstart, dragend);
            });
        }

        var getPath = function () {
            return "M" + start.x + " " + start.y + " L" + end.x + " " + end.y;
        };

        var gizmo = paper.path(getPath());

        var controls = paper.set();

        var redraw = function () {
            gizmo.attr("path", getPath());
            gizmo.attr("stroke", "red");
            gizmo.attr("stroke-width", LINE_WIDTH);
        }
    };

    $(document).ready(function () {
        var paper = Raphael("canvas", CANVAS_WIDTH, CANVAS_HEIGHT);
        var line;
        $("#canvas").dblclick(function (e) {
            x = e.offsetX;
            y = e.offsetY;
            line = new Line(x, y, x, y, paper);
            $("#canvas").bind("mousemove", function (e) {
                x = e.offsetX;
                y = e.offsetY;
                line = line.updateEnd(x, y);
            });
        });

        $("#canvas").mouseup(function (e) {
            $("#canvas").unbind("mousemove");
            if (line != undefined)
                line.enableEdit();
        });

        $("#clearBtn").click(function () {
            paper.clear();
        })
    });
    //]]> 
</script>